#include "Client.h"
#include "Globals.h"
#include "Creature.h"
#include "Guild.h"
#include "Party.h"

CClient::CClient(void)
{
	memset(MessageHandlers,0,sizeof(fMessageHandler)*MSG_HANDLERS);
	InstallMessageHandlers(this);
	DataPending.Size=0;
	DataPending.buffer=(char*)malloc(0x4000);
	DestroyMe=false;
	NextLength=0;
	nCharacters=0;
	pPlayer=0;
	pAccount=0;
	LastCast=0;
	memset(&Characters[0],0,sizeof(CPlayer *)*10);
}

CClient::~CClient(void)
{
	if (pPlayer)
	{
		pPlayer->EventsEligible=false;
		pPlayer->ClearEvents();
		RegionManager.ObjectRemove(*pPlayer);
		pPlayer->pClient=0;
	}
	if (pAccount)
	{
		pAccount->pClient=0;
		pAccount=0;
	}
	while(!Outgoing.Empty())
	{
		_OutData Data=Outgoing.Pop();
		free(Data.buffer);
	}
	DataPending.Size=0;
	if (DataPending.buffer)
	{
		free(DataPending.buffer);
		DataPending.buffer=0;
	}
}

void CClient::OutPacket(unsigned short OpCode, void *buffer, unsigned short Length)
{
	_OutData Data;
	Data.buffer=(char*)malloc(Length+6);// length + opcode + state
	*(unsigned short*)&Data.buffer[0]=ntohs(Length+4);
	*(unsigned short*)&Data.buffer[2]=OpCode;
	*(unsigned short*)&Data.buffer[4]=0;
	if (Length)
		memcpy(&Data.buffer[6],buffer,Length);
	Data.Size=Length+6;
	Outgoing.Push(Data);
}

void CClient::RegionOutPacket(unsigned short OpCode, void *buffer, unsigned short Length)
{
	CRegion *pPlayerRegion=RegionManager.ObjectRegions[pPlayer->guid];
	if (!pPlayerRegion)
	{
		OutPacket(OpCode, buffer, Length);
		return;
	}
	for (int i = 0 ; i < 3 ; i++)
	for (int j = 0 ; j < 3 ; j++)
	{
		if (CRegion *pRegion=pPlayerRegion->Adjacent[i][j])
		{
			RegionObjectNode *pNode=pRegion->pList;
			while(pNode)
			{
				if(pNode->pObject->type == OBJ_PLAYER)
					((CPlayer*)pNode->pObject)->pClient->OutPacket(OpCode,buffer,Length);
				pNode=pNode->pNext;
			}
		}
	}
}

void CClient::RegionOutPacket(unsigned short OpCode, void *buffer, unsigned short Length, float maxdist)
{
	CRegion *pPlayerRegion=RegionManager.ObjectRegions[pPlayer->guid];
	if (!pPlayerRegion)
	{
		OutPacket(OpCode, buffer, Length);
		return;
	}
	for (int i = 0 ; i < 3 ; i++)
	for (int j = 0 ; j < 3 ; j++)
	{
		if (CRegion *pRegion=pPlayerRegion->Adjacent[i][j])
		{
			RegionObjectNode *pNode=pRegion->pList;
			while(pNode)
			{
				if(pNode->pObject->type == OBJ_PLAYER && pPlayer->Distance(*((CPlayer*)pNode->pObject))<maxdist)
					((CPlayer*)pNode->pObject)->pClient->OutPacket(OpCode,buffer,Length);
				pNode=pNode->pNext;
			}
		}
	}
}

void CClient::RegionOutPacketNotMe(unsigned short OpCode, void *buffer, unsigned short Length)
{
	CRegion *pPlayerRegion=RegionManager.ObjectRegions[pPlayer->guid];
	if (!pPlayerRegion)
		return;
	for (int i = 0 ; i < 3 ; i++)
	for (int j = 0 ; j < 3 ; j++)
	{
		if (CRegion *pRegion=pPlayerRegion->Adjacent[i][j])
		{
			RegionObjectNode *pNode=pRegion->pList;
			while(pNode)
			{
				if(pNode->pObject->type == OBJ_PLAYER && ((CPlayer*)pNode->pObject)->pClient!=this)
					((CPlayer*)pNode->pObject)->pClient->OutPacket(OpCode,buffer,Length);
				pNode=pNode->pNext;
			}
		}
	}
}

void CClient::RegionOutPacketNotMe(unsigned short OpCode, void *buffer, unsigned short Length, float maxdist)
{
	CRegion *pPlayerRegion=RegionManager.ObjectRegions[pPlayer->guid];
	if (!pPlayerRegion)
		return;
	for (int i = 0 ; i < 3 ; i++)
	for (int j = 0 ; j < 3 ; j++)
	{
		if (CRegion *pRegion=pPlayerRegion->Adjacent[i][j])
		{
			RegionObjectNode *pNode=pRegion->pList;
			while(pNode)
			{
				if(pNode->pObject->type == OBJ_PLAYER && ((CPlayer*)pNode->pObject)->pClient!=this &&
					pPlayer->Distance(*((CPlayer*)pNode->pObject))<maxdist)
					((CPlayer*)pNode->pObject)->pClient->OutPacket(OpCode,buffer,Length);
				pNode=pNode->pNext;
			}
		}
	}
}

void CClient::SendCharacterList()
{
	char buffer[0x700];
	memset(buffer,0,0x700);
	int c=0;
	buffer[c++]=(unsigned char)nCharacters;
	for (int i = 0 ; i < 10 ; i++)
	{
		CPlayer *pChar=Characters[i];
		if (pChar)
		{
			// because this ID is only used for entering the world, 
			// we can have it correspond to the number of character in our list. this way,
			// we dont have to look for it later ;)
			*(unsigned long*)&buffer[c]=i+1;// guid 0 not allowed
			c+=4;
			c+=4;
			c+=pChar->GetCharListData(&buffer[c]);
		}
	}
	OutPacket(SMSG_CHAR_ENUM,buffer,c);

}

void CClient::EnterGame(unsigned long nCharacter)
{
	LastMoveFlags=-1;
	pPlayer=Characters[nCharacter-1];
	if (!pPlayer)
		return;
	pPlayer->EventsEligible=true;
	pPlayer->pClient=this;
	pPlayer->ResetFlags();
	char c=0;
	OutPacket(SMSG_FRIEND_LIST,&c,1);//empty list
	OutPacket(SMSG_IGNORE_LIST,&c,1);	// empty list

	GuildInviteID = 0;
	GuildInvitee = 0;

	PartyInviteID = 0;
	PartyInvitee = 0;
	pPlayer->Data.PartyID = 0;
	pPlayer->Data.PartyRank = 0;

	SendChatBox();
	SendKeyBindings();

	SaveBindPoint();
//	SendProficiencies();
	SendTutorialFlags();
	SendInitialSpells();
	SendBuffBar();
	SendActionButtons();
	SendFactionData();
	SendTimeSpeed();
//	SendContainers();
//	SendItems();
	SendPlayerData(true);
/**/
	Echo("Welcome to %s, running StormCraft Town Hall %s",RealmServer.Name,TOWNHALL_VERSION);
	Echo("This server is run by %s and allows up to %d simultaneous connections.",Settings.server_owner,Settings.max_connections);
	Echo("There are %d users connected, and this server has handled up to %d simultaneous users this session.",RealmServer.nClients,RealmServer.nMaxClients);
	Echo("%s",Settings.server_welcome_message);

	if(pPlayer->Data.GuildID != 0)
	{
		CGuild *pGuild = NULL;
		if(DataManager.RetrieveObject((CWoWObject**)&pGuild, OBJ_GUILD, pPlayer->Data.GuildID))
		{
			pGuild->ShowMotd(this);
		}
	}

	// Lax's Bitch movement
/*
	if (CCreature *pCreature=DataManager.CachedCreatures[0])
	{
		pCreature->Data.Loc=pPlayer->Data.Loc;
		pCreature->Data.Facing=pPlayer->Data.Facing;
		RegionManager.ObjectNew(*pCreature,pPlayer->Data.Continent,pPlayer->Data.Loc.X,pPlayer->Data.Loc.Y);
		//AddKnownCreature(*pCreature);
	}
/**/

	RegionManager.ObjectNew(*pPlayer,pPlayer->Data.Continent,pPlayer->Data.Loc.X,pPlayer->Data.Loc.Y);

	/*
	AddChannel("General");
	AddChannel("Trade");
	SendLearnedSpells();
	//	BuffDuration(0x0bdd,0x18);
	unsigned char buf[5]={0x44,3,0,0};
	OutPacket(0x123,buf,0x05);
	MakeMonster(0x475);
	/**/
	EventManager.AddEvent(*pPlayer,10000,EVENT_PLAYER_REGENERATE,0,0);
}

void CClient::LearnedSpell(unsigned long ID) 
{
	if (pPlayer->ValidateSpell(0,(short)ID))
		OutPacket(SMSG_LEARNED_SPELL,&ID,4);
	else
		Echo("You do not have the knowledge to learn this spell or ability");

}
void CClient::SendChatBox()
{
/*	
	RECV LOCALPORT 3844 <- 12.129.9.32:8086
0000   00 54 FB 01 00 00 00 00   00 00 00 00 00 00 00 00   .T..............
0010   00 00 00 00 00 00 00 00   00 00 00 00 00 00 00 00   ................
0020   00 00 00 00 00 00 00 00   00 00 00 00 00 00 00 00   ................
0030   00 00 00 00 00 00 00 00   00 00 00 00 00 00 00 00   ................
0040   00 00 00 00 00 00 00 00   00 00 00 00 00 00 00 00   ................
0050   00 00 00 00 00 00                                   ......          
*/
	unsigned char buf[0x50]={0};
	OutPacket(0x1FA,buf,0x50);
}	

void CClient::SendKeyBindings()
{
/*
SEND LOCALPORT 3844 -> 12.129.9.32:8086
0000   00 3E FD 01 00 00 03 00   00 00 32 00 00 00 78 01   .>........2...x.
0010   73 2B 4A CC 4D B5 52 08   29 2D C9 2F CA 4C CC 71   s+J.M.R.)-./.L.q
0020   03 71 B9 C0 A4 4F 6A 59   6A 8E 95 82 01 57 84 95   .q...OjYj....W..
0030   82 B1 91 01 57 A4 95 82   AE A1 91 05 17 00 B0 F4   ....W...........
*/
	/*unsigned char buf2[0x3A]={0x03,0,0,0,0x32,0,0,0,0x78,0x01,0x73,0x2B,0x4A,0xCC,0x4D,0xB5,0x52,0x08,0x29,0x2D,0xC9,
							  0x2F,0xCA,0x4C,0xCC,0x71,0x03,0x71,0xB9,0xC0,0xA4,0x4F,0x6A,0x59,0x6A,0x8E,0x95,0x82,0x01,0x57,
							  0x84,0x95,0x82,0xB1,0x91,0x01,0x57,0xA4,0x95,0x82,0xAE,0xA1,0x91,0x05,0x17,0,0xB0,0xF4
							  };*/

	// compressed text
	// 0 - config
	// 1 - bindings
	// 2 - macros
	// 3 - layout

	// packet structure similar to SMSG_COMPRESSED_OBJECT_UPDATE
	// UINT Type UINT Size BYTE Data[Size]
	char buf2[0x08];
	*(unsigned long*)&buf2[0x04] = 0;
	for(unsigned long i = 0;i < 4;i++)
	{
		*(unsigned long*)&buf2[0x00] = i;
		OutPacket(0x1FD,buf2,0x08);
	}
}	

void CClient::SaveBindPoint()
{
	char buffer[0x10];
	memcpy(&buffer[0],&pPlayer->Data.BindLoc,sizeof(_Location));
	*(unsigned long*)&buffer[sizeof(_Location)]=pPlayer->Data.BindContinent;
	OutPacket(SMSG_BINDPOINTUPDATE,buffer,0x10);
}

void CClient::SendTutorialFlags()
{
	OutPacket(SMSG_TUTORIAL_FLAGS,&pPlayer->Data.TutorialFlags,sizeof(_TutorialFlags));
}	

void CClient::SendInitialSpells()
{
//	unsigned char buf[9]={0,1,0,0x02,0x08,0x01,0x00,0,0};
//	OutPacket(SMSG_INITIAL_SPELLS,buf,0x9);
	switch(pPlayer->Data.Class) {
		case CLASS_WARRIOR: {
			// Defensive Stance, Whirlwind, Berserker Stance
			unsigned char buf[17]={0x00,0x03,0x00,0x47,0x00,0xFF,0xFF,
				0x90,0x06,0xFE,0xFF,0x9A, 0x09,0xFD,0xFF,0,0};
			OutPacket(SMSG_INITIAL_SPELLS,buf,17);
			}
			break;
		case CLASS_PALADIN: {
			// Divine Shield, Devotion Aura, and Holy Light
			unsigned char buf[17]={0x00,0x03,0x00,0x82,0x02,0x01,0x00,
				0xD1,0x01,0x02,0x00,0x7B, 0x02,0x03,0x00,0,0};
			OutPacket(SMSG_INITIAL_SPELLS,buf,17);
			}
			break;
		case CLASS_HUNTER: {
			// Beast: Tracking, Soothe, Taming
			unsigned char buf[17]={0x00,0x03,0x00,0xD6,0x05,0xFF,0xFF,
				0xE9,0x05,0xFE,0xFF,0xEB, 0x05,0xFD,0xFF,0,0};
			OutPacket(SMSG_INITIAL_SPELLS,buf,17);
			}
			break;
		case CLASS_ROGUE: {
			// Backstab, stealth, dual wield (which is passive)
			unsigned char buf[17]={0x00,0x03,0x00,0x35,0x00,0xFF,0xFF,
				0xF8,0x06,0xFE,0xFF,0xA2, 0x02,0xFD,0xFF,0,0};
			OutPacket(SMSG_INITIAL_SPELLS,buf,17);
			}
			break;
		case CLASS_PRIEST: {
			// Sleep, Lesser Heal, Shadow Word: Pain
			unsigned char buf[17]={0x00,0x03,0x00,0xBC,0x02,0x01,0x00,
				0x02,0x08,0x02,0x00,0x4D, 0x02,0x03,0x00,0,0};
			OutPacket(SMSG_INITIAL_SPELLS,buf,17);
			}
			break;
		case CLASS_SHAMAN: {
			// Lightning Bolt, Lightning shield, Restoration
			unsigned char buf[17]={0x00,0x03,0x00,0x93,0x01,0x01,0x00,
				0x44,0x01,0x02,0x00,0x4B, 0x01,0x03,0x00,0,0};
			OutPacket(SMSG_INITIAL_SPELLS,buf,17);
			}
			break;
		case CLASS_MAGE: {
			// Invisibility, Frost Armor, Fireball
			unsigned char buf[17]={0x00,0x03,0x00,0x75,0x03,0x01,0x00,
				0xA8,0x00,0x02,0x00,0x85, 0x00,0x03,0x00,0,0};
			OutPacket(SMSG_INITIAL_SPELLS,buf,17);
			}
			break;
		case CLASS_WARLOCK: {
			// Immolate, Anti-Magic, Infernal
			unsigned char buf[17]={0x00,0x03,0x00,0x5C,0x01,0x01,0x00,
				0x77,0x05,0x02,0x00,0x85, 0x05,0x03,0x00,0,0};
			OutPacket(SMSG_INITIAL_SPELLS,buf,17);
			}
			break;
		case CLASS_DRUID: {
			// Polymorph, Rejuvenation, Faerie Fire
			unsigned char buf[17]={0x00,0x03,0x00,0x90,0x04,0x01,0x00,
				0x06,0x03,0x02,0x00,0x86, 0x05,0x03,0x00,0,0};
			OutPacket(SMSG_INITIAL_SPELLS,buf,17);
			}
			break;
	}
}

void CClient::SendBuffBar()
{
	unsigned char buf[5]={0,0xDD,0x0B,0x18,0};
	OutPacket(SMSG_UPDATE_AURA_DURATION,buf,0x5);
}


void CClient::SendActionButtons()
{
	/*
______________________________________________________________
DIRECTION UNKNOWN Data len=01E4 op=011C int=0000 msglen=01E0 -- ActionButtons
0000:  CB 19 00 00-4F 02 00 00-04 08 00 00-4D 02 00 00  -...O.......M...
0010:  DB 04 00 00-BC 02 00 00-11 00 00 00-00 00 00 00  ¦...+...........
0020:  00 00 00 00-D6 07 00 00-61 FF FF FF-04 EE FF FF  ....+...a   .e  
0030:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0040:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0050:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0060:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0070:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0080:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0090:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
00A0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
00B0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
00C0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
00D0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
00E0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
00F0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0100:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0110:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0120:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0130:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0140:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0150:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0160:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0170:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0180:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0190:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
01A0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
01B0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
01C0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
01D0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	/**/
	unsigned char buf[0x1e0]={
0xCB,0x19,0x00,0x00,0x4F,0x02,0x00,0x00,0x04,0x08,0x00,0x00,0x4D,0x02,0x00,0x00,
0xDB,0x04,0x00,0x00,0xBC,0x02,0x00,0x00,0x11,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xD6,0x07,0x00,0x00,0x61,0xFF,0xFF,0xFF,0x04,0xEE,0xFF,0xFF,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	};
	OutPacket(SMSG_ACTION_BUTTONS,buf,0x1e0);
}

void CClient::SendFactionData()
{
	/*
______________________________________________________________
DIRECTION UNKNOWN Data len=0148 op=0115 int=0000 msglen=0144 -- FactionUpdate
0000:  40 00 00 00-02 00 00 00-00 00 00 00-00 00 02 00  @...............
0010:  00 00 00 02-00 00 00 00-00 00 00 00-00 00 00 00  ................
0020:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0030:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0040:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0050:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0060:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0070:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0080:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0090:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
00A0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
00B0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
00C0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
00D0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
00E0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
00F0:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0100:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0110:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0120:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0130:  00 00 00 00-00 00 00 00-00 00 00 00-00 00 00 00  ................
0140:  00 00 00 00-           -           -             ....            
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	/**/
	unsigned char buf[0x144]={
0x40,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00
,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00
	};
	OutPacket(SMSG_INITIALIZE_FACTIONS,buf,0x144);
}

void CClient::SendTimeSpeed()
{
	/*
______________________________________________________________
DIRECTION UNKNOWN Data len=000C op=0042 int=0000 msglen=0008 -- NewTimeSpeed
0000:  DB 53 01 04-89 88 88 3C-           -             ¦S..ëêê<        
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	/**/
	unsigned char buf[8]={0xdb,0x53,0x01,0x04,0x89,0x88,0x88,0x3c};
//	*(time_t*)&buf[0]=time(0);
//	*(unsigned long*)&buf[4]=0x3c888889;
	OutPacket(SMSG_LOGIN_SETTIMESPEED,(char*)&buf[0],8);
}

void CClient::SendPlayerData(bool Create)
{
/*
	unsigned char xbuffer[0xa9f]={
 0x01,0x00,0x00,0x00,0x02,0xAE,0x01,0x05,0x40,0x00,0x00,0x00
,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x24,0x2A,0xA7,0xC5,0x86,0xFE
,0x38,0xC5,0x3E,0xD0,0xA1,0x43,0x84,0x7C,0x49,0x40,0x24,0x2A,0xA7,0xC5,0x86,0xFE
,0x38,0xC5,0x3E,0xD0,0xA1,0x43,0x84,0x7C,0x49,0x40,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x40,0x00,0x00,0xE0,0x40,0x72,0x1C
,0x97,0x40,0xDB,0x0F,0x49,0x40,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x14,0xFF,0xFF,0xFF,0xFF,0xFF
,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
// guid             |                   |
,0xAE,0x01,0x05,0x40,0x00,0x00,0x00,0x00
// unknown          |                   |         size      |
,0x19,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x3F
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  | hps               |mana               |energy
,0x00,0x00,0x00,0x00,0x78,0x00,0x00,0x00,0x78,0x00,0x00,0x00,0xE8,0x03,0x00,0x00
//focus             | rage              |max hps            |max mana
,0x0A,0x00,0x00,0x00,0x64,0x00,0x00,0x00,0x78,0x00,0x00,0x00,0x78,0x00,0x00,0x00
// max energy       |max focus          |max rage           | level
,0xE8,0x03,0x00,0x00,0x0A,0x00,0x00,0x00,0x64,0x00,0x00,0x00,0x0C,0x00,0x00,0x00
// unknown          |race/class/sex/bar | strength         | agility
,0x05,0x00,0x00,0x00,0x02,0x01,0x00,0x01,0x78,0x00,0x00,0x00,0x46,0x00,0x00,0x00
//stamina           | int               | spirit            | normal str
,0x28,0x00,0x00,0x00,0x54,0x01,0x00,0x00,0x1E,0x00,0x00,0x00,0x78,0x00,0x00,0x00
// normal agi       |normal sta         |normal int         |normal spirit
,0x46,0x00,0x00,0x00,0x28,0x00,0x00,0x00,0x54,0x01,0x00,0x00,0x1E,0x00,0x00,0x00
//  ?               |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//   ?              |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |wealth total       |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x9A,0x02,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   | dmg bonus (melee only?)
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x09,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |          
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   | atk speed * 100
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF4,0x1A,0x00,0x00
//   2000           |  armor            |resist holy        |resist fire
,0xD0,0x07,0x00,0x00,0x19,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x32,0x00,0x00,0x00
//resist nature     | resist frost      |resist shadow      | ? 
,0x4B,0x00,0x00,0x00,0x1E,0x00,0x00,0x00,0x0A,0x00,0x00,0x00,0x93,0x18,0xC4,0x3E
//        ?         |                   |model              |
,0x00,0x00,0xC0,0x3F,0x00,0x00,0x00,0x00,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//dmg min |dmg max  |                   |resist holy mod    |resist fire mod
,0x04,0x00,0x0a,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x05,0x00,0x00,0x00
//resist nature mod |resist frost mod   |resist shadow mod  |
,0x07,0x00,0x00,0x00,0x09,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
// items here somewhere
//                  |                   |                   | item #1
,0x37,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0x39,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  | item #2           |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  | item #4           |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       6           |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       8           |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       10          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       12          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       14          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       16          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       18          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       20          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       22          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       24          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       26          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       28          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       30          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       32          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       34          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       36          |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |       38          |                   |       39
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//   39             |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   | ?
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x45,0x00,0x00,0x00
//                  |                   |appearance?        | exp
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x02,0x05,0x00,0x00,0x00,0x00,0x00
//next level        |                   |                   |
,0x50,0xC3,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB0,0x04,0x00,0x00
//                  |                   |                   |
,0x00,0x00,0x00,0x00
	};
	/*
	int nSize=Compressor.Deflate(buffer,0xa9f);	
	if (!nSize)
	{
		Debug.Log("Deflate failed\n");
		return;
	}
	char *buf=(char*)malloc(nSize+4);
	*(unsigned long*)&buf[0]=0xa9f;
	Compressor.GetBuffer(&buf[4]);
	OutPacket(0x1e7,buf,nSize+4);
	free(buf);

					unsigned char fbuf[0x30]=
					{
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x49,0x57,0x70,0x41,0x2C,0x19,0x00,0x42
,0x54,0x17,0x71,0x42,0x3C,0x27,0x99,0x3F,0x49,0x57,0x70,0x41,0x2C,0x19,0x00,0x42
,0x54,0x17,0x71,0x42,0x3C,0x27,0x99,0x3F,0x00,0x00,0x00,0x00,0x01,0x02,0x80,0x00
					};
					*(float*)&fbuf[0x08]=0.0f;
					*(float*)&fbuf[0x0c]=0.0f;
					*(float*)&fbuf[0x10]=400.0f;
					// heading
					*(float*)&fbuf[0x18]=0.0f;
					*(float*)&fbuf[0x1c]=0.0f;
					*(float*)&fbuf[0x20]=400.0f;
					// heading
					pPlayer->Data.Loc.X=0.0f;
					pPlayer->Data.Loc.Y=0.0f;
					pPlayer->Data.Loc.Z=400.0f;;
					OutPacket(0xC7,fbuf,0x30);

	/**/

// first, items:
	char buffer[0x1000];
	memset(buffer,0,0x1000);
	buffer[0]=1;
	buffer[4]=2*Create;
	int oSize=pPlayer->GetPlayerInfoData(&buffer[5],Create)+5;
	int nSize=Compressor.Deflate(buffer,oSize);	
	if (!nSize)
	{
		Debug.Log("Deflate failed\n");
		return;
	}
	char *buf=(char*)malloc(nSize+4);
	*(unsigned long*)&buf[0]=oSize;
	Compressor.GetBuffer(&buf[4]);
	OutPacket(SMSG_COMPRESSED_UPDATE_OBJECT,buf,nSize+4);
	free(buf);

	if (Create)
	{
		for (unsigned long i = 0 ; i < 40 ; i++)
		{
			if (unsigned long ItemID=pPlayer->Data.Items[i])
			{
				//memset(buffer,0,0x1000);
				CItem *pItem=0;
				if (DataManager.RetrieveObject((CWoWObject**)&pItem,OBJ_ITEM,ItemID))
				{
					AddKnownItem(*pItem);
				}
				else
				{
					// error... client will crash if we dont clear this.
					pPlayer->Data.Items[i]=0;
				}
			}
		}
	}
	/**/
}


void CClient::ChannelMessage(unsigned char Channel, const char *message, unsigned long user, const char *channelname, unsigned long Language)
{
/*
______________________________________________________________
DIRECTION UNKNOWN Data len=008C op=0096 int=0000 msglen=0088 -- ChatHandler
0000:  0D 00 00 00-00 54 72 61-64 65 00 F9-65 01 00 00  .....Trade.·e...
0010:  00 00 00 4D-61 6B 69 6E-67 20 7C 48-69 74 65 6D  ...Making |Hitem
0020:  3A 35 39 36-32 7C 68 5B-47 75 61 72-64 69 61 6E  :5962|h[Guardian
0030:  20 50 61 6E-74 73 5D 7C-68 20 66 72-65 65 20 66   Pants]|h free f
0040:  6F 72 20 61-6C 6C 20 6D-79 20 66 72-69 65 6E 64  or all my friend
0050:  73 20 61 6E-64 20 66 61-6D 69 6C 79-2E 2E 2E 20  s and family... 
0060:  79 61 20 6A-75 73 74 20-67 6F 74 74-61 20 62 72  ya just gotta br
0070:  69 6E 67 20-74 68 65 20-31 32 20 48-76 79 20 6C  ing the 12 Hvy l
0080:  65 61 74 68-65 72 00 00-           -             eather..        
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
/**/
/*
______________________________________________________________
DIRECTION UNKNOWN Data len=0022 op=0096 int=0000 msglen=001E -- ChatHandler
0000:  09 00 00 00-00 00 00 00-00 00 00 00-00 45 6E 6A  .............Enj
0010:  6F 79 20 74-68 65 20 67-61 6D 65 21-00 00        oy the game!..  
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


/**/
	char buffer[2048];
	memset(buffer,0,2048);
	int c = 0;
	buffer[c++]=Channel;
	*(unsigned long*)&buffer[c]=Language;
	// unknown
	c+=4;
	if (channelname)
	{
		strcpy(&buffer[c],channelname);
		c+=strlen(channelname);
		c++;
	}
	*(unsigned long*)&buffer[c]=user;
	c+=4;
// Hmm I wonder what this is? - Fnag
//	*(unsigned long*)&buffer[c]=????;  // unknown
	c+=4;
	strcpy(&buffer[c],message);
	c+=strlen(message)+1;
	// unknown single byte
	buffer[c] = pPlayer->Data.StatusFlags;
	c++;
	OutPacket(SMSG_MESSAGECHAT,buffer,c);
}

void CClient::AddKnownCreature(CCreature &Creature)
{
	char buffer[300];
	memset(&buffer[0],0,300);
	buffer[0]=1;
	buffer[4]=2;
	int oSize=Creature.GetCreatureInfoData(&buffer[5])+5;
	int nSize=Compressor.Deflate(buffer,oSize);	
	if (!nSize)
	{
		Debug.Log("Deflate failed\n");
		return;
	}
	char *buf=(char*)malloc(nSize+4);
	*(unsigned long*)&buf[0]=oSize;
	Compressor.GetBuffer(&buf[4]);
	OutPacket(SMSG_COMPRESSED_UPDATE_OBJECT,buf,nSize+4);
	free(buf);
}

void CClient::UpdateKnownCreature(CCreature &Creature)
{
	char buffer[300];
	memset(&buffer[0],0,300);
	buffer[0]=1;
	buffer[4]=0;// update object
	int oSize=Creature.GetCreatureInfoData(&buffer[5],false)+5;
	int nSize=Compressor.Deflate(buffer,oSize);	
	if (!nSize)
	{
		Debug.Log("Deflate failed\n");
		return;
	}
	char *buf=(char*)malloc(nSize+4);
	*(unsigned long*)&buf[0]=oSize;
	Compressor.GetBuffer(&buf[4]);
	OutPacket(SMSG_COMPRESSED_UPDATE_OBJECT,buf,nSize+4);
	free(buf);
}

void CClient::AddKnownItem(class CItem &Item)
{
	char buffer[0x1000];
	memset(buffer,0,0x1000);
	buffer[0]=1;
	buffer[4]=2;// create object
	int oSize=Item.GetItemInfoData(&buffer[5])+5;
	int nSize=Compressor.Deflate(buffer,oSize);	
	if (!nSize)
	{
		Debug.Log("Deflate failed\n");
		return;
	}
	char *buf=(char*)malloc(nSize+4);
	*(unsigned long*)&buf[0]=oSize;
	Compressor.GetBuffer(&buf[4]);
	OutPacket(SMSG_COMPRESSED_UPDATE_OBJECT,buf,nSize+4);
	free(buf);
}

void CClient::UpdateKnownItem(class CItem &Item)
{
	char buffer[0x1000];
	memset(buffer,0,0x1000);
	buffer[0]=1;
	buffer[4]=0;// update object
	int oSize=Item.GetItemInfoData(&buffer[5],false)+5;
	int nSize=Compressor.Deflate(buffer,oSize);	
	if (!nSize)
	{
		Debug.Log("Deflate failed\n");
		return;
	}
	char *buf=(char*)malloc(nSize+4);
	*(unsigned long*)&buf[0]=oSize;
	Compressor.GetBuffer(&buf[4]);
	OutPacket(SMSG_COMPRESSED_UPDATE_OBJECT,buf,nSize+4);
	free(buf);
}

void CClient::AddKnownPlayer(CPlayer &Player)
{
	char buffer[0x1000];

	for (unsigned long i = 0 ; i < 19 ; i++)
	{
		if (unsigned long ItemID=Player.Data.Items[i])
		{
			memset(buffer,0,0x1000);
			CItem *pItem=0;
			if (DataManager.RetrieveObject((CWoWObject**)&pItem,ItemID))
			{
				AddKnownItem(*pItem);
				/*
				buffer[0]=1;
				buffer[4]=2;
				int oSize=pItem->GetItemInfoData(&buffer[5])+5;
				int nSize=Compressor.Deflate(buffer,oSize);	
				if (nSize)
				{
					char *buf=(char*)malloc(nSize+4);
					*(unsigned long*)&buf[0]=oSize;
					Compressor.GetBuffer(&buf[4]);
					OutPacket(SMSG_COMPRESSED_UPDATE_OBJECT,buf,nSize+4);
					free(buf);
				}
				else
					Debug.Log("Deflate failed\n");
				/**/
			}
		}
	}

	memset(buffer,0,0x1000);
	buffer[0]=1;
	buffer[4]=2;
	int oSize=Player.GetOtherPlayerInfoData(&buffer[5])+5;
	int nSize=Compressor.Deflate(buffer,oSize);	
	if (!nSize)
	{
		Debug.Log("Deflate failed\n");
		return;
	}
	char *buf=(char*)malloc(nSize+4);
	*(unsigned long*)&buf[0]=oSize;
	Compressor.GetBuffer(&buf[4]);
	OutPacket(SMSG_COMPRESSED_UPDATE_OBJECT,buf,nSize+4);
	free(buf);
}

void CClient::UpdateKnownPlayer(CPlayer &Player)
{
	char buffer[0x1000];

	memset(buffer,0,0x1000);
	buffer[0]=1;
	buffer[4]=0;
	int oSize=Player.GetOtherPlayerInfoData(&buffer[5],false)+5;
	int nSize=Compressor.Deflate(buffer,oSize);	
	if (!nSize)
	{
		Debug.Log("Deflate failed\n");
		return;
	}
	char *buf=(char*)malloc(nSize+4);
	*(unsigned long*)&buf[0]=oSize;
	Compressor.GetBuffer(&buf[4]);
	OutPacket(SMSG_COMPRESSED_UPDATE_OBJECT,buf,nSize+4);
	free(buf);
}

void CClient::RemoveKnownPlayer(CPlayer &Player)
{
	char buf[8];
	*(unsigned long*)&buf[0]=Player.guid;
	*(unsigned long*)&buf[4]=0x00000000;
	OutPacket(SMSG_DESTROY_OBJECT,buf,8);
}

void CClient::RemoveKnownCreature(class CCreature &Creature)
{
	char buf[8];
	*(unsigned long*)&buf[0]=Creature.guid;
	*(unsigned long*)&buf[4]=0xF0001000;
	OutPacket(SMSG_DESTROY_OBJECT,buf,8);
}

void CClient::RemoveKnownItem(class CItem &Item)
{
	char buf[8];
	*(unsigned long*)&buf[0]=Item.guid;
	*(unsigned long*)&buf[4]=0x40000000;
	OutPacket(SMSG_DESTROY_OBJECT,buf,8);
}


void CClient::ChatSay(unsigned long Language,const char *Msg)
{
	CRegion *pPlayerRegion=RegionManager.ObjectRegions[pPlayer->guid];
	if (!pPlayerRegion)
		return;
	for (int i = 0 ; i < 3 ; i++)
	for (int j = 0 ; j < 3 ; j++)
	{
		if (CRegion *pRegion=pPlayerRegion->Adjacent[i][j])
		{
			RegionObjectNode *pNode=pRegion->pList;
			while(pNode)
			{
				switch(pNode->pObject->type)
				{
				case OBJ_PLAYER:
					if (pPlayer->Distance(*((CPlayer*)pNode->pObject))<SAYDIST)
						((CPlayer*)pNode->pObject)->pClient->ChannelMessage(CHAT_SAY,Msg,pPlayer->guid,0,0);
					break;
				}
				pNode=pNode->pNext;
			}
		}
	}
}

void CClient::ChatYell(unsigned long Language,const char *Msg)
{
CRegion *pPlayerRegion=RegionManager.ObjectRegions[pPlayer->guid];
	if (!pPlayerRegion)
		return;
	for (int i = 0 ; i < 3 ; i++)
	for (int j = 0 ; j < 3 ; j++)
	{
		if (CRegion *pRegion=pPlayerRegion->Adjacent[i][j])
		{
			RegionObjectNode *pNode=pRegion->pList;
			while(pNode)
			{
				switch(pNode->pObject->type)
				{
				case OBJ_PLAYER:
					if (pPlayer->Distance(*((CPlayer*)pNode->pObject))<YELLDIST)
						((CPlayer*)pNode->pObject)->pClient->ChannelMessage(CHAT_YELL,Msg,pPlayer->guid,0,0);
					break;
				}
				pNode=pNode->pNext;
			}
		}
	}
}

void CClient::Echo(const char *format,...)
{
    CHAR szOutput[20480] = {0};
    va_list vaList;
    va_start( vaList, format );
    vsprintf(szOutput,format, vaList);
	ChannelMessage(9,szOutput,0,0,0);	
}

void CClient::Emote(unsigned long who, unsigned long animation, unsigned long code, unsigned long target, char *name, int plen, unsigned long targettype)
{
	CRegion *pPlayerRegion=RegionManager.ObjectRegions[pPlayer->guid];
	if (!pPlayerRegion)
		return;
	for (int i = 0 ; i < 3 ; i++)
	for (int j = 0 ; j < 3 ; j++)
	{
		if (CRegion *pRegion=pPlayerRegion->Adjacent[i][j])
		{
			RegionObjectNode *pNode=pRegion->pList;
			while(pNode)
			{
				switch(pNode->pObject->type)
				{
				case OBJ_PLAYER:
					if (pPlayer->Distance(*((CPlayer*)pNode->pObject))<EMOTEDIST) // && pPlayer->guid != who)
					{
						((CPlayer*)pNode->pObject)->pClient->EmoteAnim(animation, who, targettype);
						((CPlayer*)pNode->pObject)->pClient->EmoteText(who, target, code, name, plen, targettype);
					}
					break;
				}
				pNode=pNode->pNext;
			}
		}
	}
}


void CClient::EmoteAnim(unsigned long animation, unsigned long who, unsigned long targettype)
{
	char buffer[12];
	memset(buffer, 0x00, 12);
	*(unsigned long*)&buffer[0] = animation;
	*(unsigned long*)&buffer[4] = who;
	*(unsigned long*)&buffer[8] = targettype;
	OutPacket(SMSG_EMOTE, buffer, 12);
}

void CClient::EmoteText(unsigned long who, unsigned long target, unsigned long code, char *name, int plen, unsigned long targettype)
{
	char buffer[76];
	memset(buffer, 0x00, 76);
	*(unsigned long*)&buffer[0] = who;
	*(unsigned long*)&buffer[4] = targettype;
	*(unsigned long*)&buffer[8] = code;
	if (plen > 13)
			strcpy(&buffer[12], name);
	OutPacket(SMSG_TEXT_EMOTE, buffer, plen);
}

void CClient::InterruptCast(unsigned long spell)
{
	char buffer[0x0D];
	memset(buffer, 0, 0x0D);
	*(unsigned long*)&buffer[0]=pPlayer->guid;
	*(unsigned long*)&buffer[8]=spell;
	buffer[12]=0x11;
	OutPacket(SMSG_SPELL_FAILURE,buffer,0x0D);
	memset(buffer, 0, 0x06);
	*(unsigned long*)&buffer[0]=spell;
	*(unsigned short*)&buffer[4]=0x1102;
	OutPacket(SMSG_CAST_RESULT,buffer,0x06);
}

void CClient::UpdateRunSpeed(CPlayer &Player)
{
	char buf[0x20];
	*(unsigned long*)&buf[0x00] = pPlayer->guid;
	*(unsigned long*)&buf[0x04] = 0;
	*(unsigned long*)&buf[0x08] = 0; // movement flags
	*(_Location*)&buf[0x0C] = pPlayer->Data.Loc;
	*(float*)&buf[0x18] = pPlayer->Data.Facing;
	*(float*)&buf[0x1C] = pPlayer->Data.runspeed;
	OutPacket(SMSG_FORCE_SPEED_CHANGE,(char*)&pPlayer->Data.runspeed,0x4);
	RegionOutPacketNotMe(MSG_MOVE_SET_RUN_SPEED, buf, 0x20);
}
